---
description: Rule describing Alembic migration file management and usage in 'back/migrations', including versioning, upgrade/downgrade commands, and structure.
alwaysApply: false
---
# Database Migrations

## Overview

Tastify uses Alembic for database migrations with async SQLAlchemy support. Migrations are stored in `back/migrations/versions/`.

## Structure

```
back/
  alembic.ini              - Alembic configuration
  migrations/
    env.py                 - Migration environment (async setup)
    script.py.mako         - Template for new migrations
    versions/
      001_initial.py       - Initial schema (rooms, players, game_rounds)
```

## Running Migrations

### Apply All Migrations
```bash
cd back
uv run alembic upgrade head
```

### Rollback One Migration
```bash
uv run alembic downgrade -1
```

### Rollback to Specific Revision
```bash
uv run alembic downgrade <revision_id>
```

### View Current Revision
```bash
uv run alembic current
```

### View Migration History
```bash
uv run alembic history
```

## Creating a New Migration

### Option 1: Auto-generate from Models (Recommended)

1. **Update or create model** in `src/models/`:

```python
# src/models/my_model.py
from sqlalchemy import Integer, String
from sqlalchemy.orm import Mapped, mapped_column
from src.db.base import Base

class MyModel(Base):
    __tablename__ = "my_models"

    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String(100))
```

2. **Import model in `src/models/__init__.py`**:

```python
from src.models.my_model import MyModel
```

3. **Generate migration**:

```bash
cd back
uv run alembic revision --autogenerate -m "Add my_model table"
```

4. **Review generated migration** in `migrations/versions/` and adjust if needed.

5. **Apply migration**:

```bash
uv run alembic upgrade head
```

### Option 2: Manual Migration

1. **Create empty migration**:

```bash
cd back
uv run alembic revision -m "Add index to players"
```

2. **Edit generated file**:

```python
# migrations/versions/xxx_add_index_to_players.py
def upgrade() -> None:
    op.create_index("ix_players_name", "players", ["name"])

def downgrade() -> None:
    op.drop_index("ix_players_name", table_name="players")
```

3. **Apply**:

```bash
uv run alembic upgrade head
```

## Migration Best Practices

### Naming Convention
- Use descriptive names: `add_user_preferences_table`, `add_index_to_rooms_code`
- Prefix with sequential number for ordering: `002_add_preferences.py`

### Always Write Downgrade
- Every `upgrade()` should have a corresponding `downgrade()`
- Test both directions locally before committing

### Column Changes
```python
# Add nullable column
op.add_column("users", sa.Column("avatar_url", sa.String(255), nullable=True))

# Add non-nullable column with default
op.add_column("users", sa.Column("is_active", sa.Boolean(), nullable=False, server_default="true"))

# Drop column
op.drop_column("users", "avatar_url")
```

### Index Operations
```python
# Create index
op.create_index("ix_rooms_created_at", "rooms", ["created_at"])

# Drop index
op.drop_index("ix_rooms_created_at", table_name="rooms")
```

### Enum Types
```python
# Create enum
room_status = sa.Enum("WAITING", "PLAYING", "FINISHED", name="roomstatus")
room_status.create(op.get_bind())

# Drop enum (in downgrade)
op.execute("DROP TYPE IF EXISTS roomstatus")
```

### Foreign Keys
```python
# Add foreign key
op.add_column("scores", sa.Column("player_id", sa.Integer(), nullable=False))
op.create_foreign_key(
    "fk_scores_player_id",
    "scores", "players",
    ["player_id"], ["id"],
    ondelete="CASCADE"
)

# Drop foreign key
op.drop_constraint("fk_scores_player_id", "scores", type_="foreignkey")
op.drop_column("scores", "player_id")
```

## Testing Migrations

In tests, the schema is created directly from models using `Base.metadata.create_all()`. For production-like testing:

```bash
# Fresh database
docker compose -f docker/docker-compose.yaml down -v
docker compose -f docker/docker-compose.yaml up postgres -d

# Run all migrations
cd back
uv run alembic upgrade head

# Verify
uv run alembic current
```

## Troubleshooting

### "Target database is not up to date"
```bash
uv run alembic stamp head  # Mark current state as head
```

### Migration Conflicts
If two developers create migrations simultaneously:
1. Roll back to common ancestor
2. Merge or reorder migrations
3. Update `down_revision` references

### Check Migration SQL
```bash
uv run alembic upgrade head --sql  # Shows SQL without executing
```
